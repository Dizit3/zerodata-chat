# ZeroData Chat: Правила для AI-агентов

Этот файл содержит критические инструкции по архитектуре и логике приложения для обеспечения стабильности и предотвращения регрессий.

## 1. Архитектурный паттерн
Приложение строго следует Clean Architecture / MVVM:
- **UI (Compose)**: Только отображение данных и захват событий ввода. Никакой бизнес-логики.
- **ViewModel**: Подготовка данных из репозитория для UI через `StateFlow`.
- **Repository (`ChatRepository`)**: Единый источник истины. Связывает локальную базу данных (Room) и сетевой слой (MQTT).
- **Network (`MqttManager`)**: Низкоуровневая работа с протоколом.

**ПРАВИЛО**: Запрещено обращаться к `MqttManager` или `AppDatabase` напрямую из UI или ViewModels. Всегда используйте `ChatRepository`.

## 2. Логика идентификации (Chat ID)
Для обеспечения консистентности чатов между двумя пользователями используется детерминированный алгоритм формирования ID.
- **Алгоритм**: Сортировка по алфавиту двух User ID и объединение через нижнее подчеркивание.
- **Утилита**: `ChatUtils.getCanonicalChatId(user1, user2)`.

**ПРАВИЛО**: Всегда используйте `ChatUtils` для получения ID чата. Не генерируйте случайные ID для личных переписок.

## 3. Работа с данными
- **Immutability**: Все модели (`Chat`, `Message`) должны использовать `val` поля.
- **Mapping**: Модели базы данных (`Entity`) не должны выходить за пределы репозитория. Преобразуйте их в domain-модели (`model`) перед передачей в ViewModel.

## 4. Сетевой слой (MQTT)
- **Топики**: Структура топиков жестко задана в `Constants.kt`.
- **Формат**: Приложение использует JSON для обмена сообщениями через `MqttPayloadMapper`.
- **Стабильность**: Соединение должно управляться через `CoroutineScope` с учетом жизненного цикла приложения.

## 5. Процесс изменений
1. **Проверка**: Перед изменением логики репозитория или сетевого слоя, агент обязан проверить `ChatRepositoryImpl.kt`.
2. **Безопасность**: Запрещено удалять `GlobalExceptionHandler` или изменять структуру `CrashActivity` без явного указания пользователя.
3. **Обновления**: Логика `UpdateManager` завязана на GitHub Releases. Не меняйте логику сравнения версий без понимания структуры тегов в репозитории.

## 6. Интерфейс
- Используется только **Vanilla CSS/Compose Material3**. 
- Основная цветовая схема — темная (`0xFF121212`).
- Кнопка "Новый чат" в `AddChatDialog` является обязательной системной функцией.
